"""
Day 2 - ä»»åŠ¡2.2: æ¡‘åŸºå›¾é«˜çº§è®¾è®¡
åŒ…å«: å¤šå±‚çº§æ¡‘åŸºå›¾ã€äº¤äº’å¼æ¡‘åŸºå›¾
"""

import plotly.graph_objects as go
import numpy as np

print("=" * 60)
print("Day 2 - ä»»åŠ¡2.2: æ¡‘åŸºå›¾é«˜çº§è®¾è®¡")
print("=" * 60)

# ============================================================================
# 1. å¤æ‚å¤šå±‚çº§æ¡‘åŸºå›¾ - èƒ½æºæµåŠ¨
# ============================================================================
print("\n[1/2] åˆ›å»ºå¤æ‚å¤šå±‚çº§æ¡‘åŸºå›¾...")

# å®šä¹‰èŠ‚ç‚¹ï¼ˆæŒ‰å±‚çº§æ’åˆ—ï¼‰
# ç¬¬ä¸€å±‚ï¼šèƒ½æºæ¥æº
# ç¬¬äºŒå±‚ï¼šè½¬æ¢è¿‡ç¨‹
# ç¬¬ä¸‰å±‚ï¼šæœ€ç»ˆç”¨é€”
labels = [
    # ç¬¬ä¸€å±‚ï¼šèƒ½æºæ¥æº (0-4)
    'ç…¤ç‚­', 'å¤©ç„¶æ°”', 'çŸ³æ²¹', 'æ ¸èƒ½', 'å¯å†ç”Ÿèƒ½æº',
    # ç¬¬äºŒå±‚ï¼šè½¬æ¢è¿‡ç¨‹ (5-8)
    'å‘ç”µ', 'ä¾›çƒ­', 'äº¤é€šç‡ƒæ–™', 'å·¥ä¸šåŸæ–™',
    # ç¬¬ä¸‰å±‚ï¼šæœ€ç»ˆç”¨é€” (9-13)
    'å±…æ°‘ç”¨ç”µ', 'å·¥ä¸šç”¨ç”µ', 'å•†ä¸šç”¨ç”µ', 'å±…æ°‘ä¾›æš–', 'äº¤é€šè¿è¾“'
]

# å®šä¹‰è¿æ¥å…³ç³»
# source: æºèŠ‚ç‚¹ç´¢å¼•
# target: ç›®æ ‡èŠ‚ç‚¹ç´¢å¼•
# value: æµé‡å€¼
source = [
    # ç¬¬ä¸€å±‚ -> ç¬¬äºŒå±‚
    0, 0, 0, 0,  # ç…¤ç‚­
    1, 1, 1,     # å¤©ç„¶æ°”
    2, 2,        # çŸ³æ²¹
    3,           # æ ¸èƒ½
    4, 4,        # å¯å†ç”Ÿèƒ½æº
    # ç¬¬äºŒå±‚ -> ç¬¬ä¸‰å±‚
    5, 5, 5,     # å‘ç”µ
    6,           # ä¾›çƒ­
    7,           # äº¤é€šç‡ƒæ–™
    8            # å·¥ä¸šåŸæ–™
]

target = [
    # ç¬¬ä¸€å±‚ -> ç¬¬äºŒå±‚
    5, 6, 7, 8,  # ç…¤ç‚­ -> å‘ç”µã€ä¾›çƒ­ã€äº¤é€šç‡ƒæ–™ã€å·¥ä¸šåŸæ–™
    5, 6, 8,     # å¤©ç„¶æ°” -> å‘ç”µã€ä¾›çƒ­ã€å·¥ä¸šåŸæ–™
    7, 8,        # çŸ³æ²¹ -> äº¤é€šç‡ƒæ–™ã€å·¥ä¸šåŸæ–™
    5,           # æ ¸èƒ½ -> å‘ç”µ
    5, 6,        # å¯å†ç”Ÿèƒ½æº -> å‘ç”µã€ä¾›çƒ­
    # ç¬¬äºŒå±‚ -> ç¬¬ä¸‰å±‚
    9, 10, 11,   # å‘ç”µ -> å±…æ°‘ç”¨ç”µã€å·¥ä¸šç”¨ç”µã€å•†ä¸šç”¨ç”µ
    12,          # ä¾›çƒ­ -> å±…æ°‘ä¾›æš–
    13,          # äº¤é€šç‡ƒæ–™ -> äº¤é€šè¿è¾“
    10           # å·¥ä¸šåŸæ–™ -> å·¥ä¸šç”¨ç”µ
]

value = [
    # ç¬¬ä¸€å±‚ -> ç¬¬äºŒå±‚
    40, 15, 5, 10,   # ç…¤ç‚­
    25, 10, 5,       # å¤©ç„¶æ°”
    30, 10,          # çŸ³æ²¹
    20,              # æ ¸èƒ½
    15, 5,           # å¯å†ç”Ÿèƒ½æº
    # ç¬¬äºŒå±‚ -> ç¬¬ä¸‰å±‚
    30, 40, 30,      # å‘ç”µ
    30,              # ä¾›çƒ­
    35,              # äº¤é€šç‡ƒæ–™
    25               # å·¥ä¸šåŸæ–™
]

# å®šä¹‰é¢œè‰²
node_colors = [
    # ç¬¬ä¸€å±‚ï¼šèƒ½æºæ¥æºï¼ˆæ·±è‰²ï¼‰
    'rgba(50, 50, 50, 0.8)',      # ç…¤ç‚­ - é»‘è‰²
    'rgba(100, 150, 200, 0.8)',   # å¤©ç„¶æ°” - è“è‰²
    'rgba(150, 100, 50, 0.8)',    # çŸ³æ²¹ - æ£•è‰²
    'rgba(200, 100, 100, 0.8)',   # æ ¸èƒ½ - çº¢è‰²
    'rgba(100, 200, 100, 0.8)',   # å¯å†ç”Ÿèƒ½æº - ç»¿è‰²
    # ç¬¬äºŒå±‚ï¼šè½¬æ¢è¿‡ç¨‹ï¼ˆä¸­ç­‰è‰²ï¼‰
    'rgba(255, 200, 100, 0.8)',   # å‘ç”µ - æ©™è‰²
    'rgba(255, 150, 150, 0.8)',   # ä¾›çƒ­ - ç²‰è‰²
    'rgba(150, 150, 255, 0.8)',   # äº¤é€šç‡ƒæ–™ - æµ…è“
    'rgba(200, 200, 100, 0.8)',   # å·¥ä¸šåŸæ–™ - é»„è‰²
    # ç¬¬ä¸‰å±‚ï¼šæœ€ç»ˆç”¨é€”ï¼ˆæµ…è‰²ï¼‰
    'rgba(255, 220, 150, 0.8)',   # å±…æ°‘ç”¨ç”µ
    'rgba(255, 180, 100, 0.8)',   # å·¥ä¸šç”¨ç”µ
    'rgba(255, 200, 150, 0.8)',   # å•†ä¸šç”¨ç”µ
    'rgba(255, 180, 180, 0.8)',   # å±…æ°‘ä¾›æš–
    'rgba(180, 180, 255, 0.8)'    # äº¤é€šè¿è¾“
]

# è¿æ¥é¢œè‰²ï¼ˆä½¿ç”¨åŠé€æ˜ï¼‰
link_colors = [
    'rgba(50, 50, 50, 0.3)',      # ç…¤ç‚­ç›¸å…³
    'rgba(50, 50, 50, 0.3)',
    'rgba(50, 50, 50, 0.3)',
    'rgba(50, 50, 50, 0.3)',
    'rgba(100, 150, 200, 0.3)',   # å¤©ç„¶æ°”ç›¸å…³
    'rgba(100, 150, 200, 0.3)',
    'rgba(100, 150, 200, 0.3)',
    'rgba(150, 100, 50, 0.3)',    # çŸ³æ²¹ç›¸å…³
    'rgba(150, 100, 50, 0.3)',
    'rgba(200, 100, 100, 0.3)',   # æ ¸èƒ½ç›¸å…³
    'rgba(100, 200, 100, 0.3)',   # å¯å†ç”Ÿèƒ½æºç›¸å…³
    'rgba(100, 200, 100, 0.3)',
    'rgba(255, 200, 100, 0.4)',   # å‘ç”µç›¸å…³
    'rgba(255, 200, 100, 0.4)',
    'rgba(255, 200, 100, 0.4)',
    'rgba(255, 150, 150, 0.4)',   # ä¾›çƒ­ç›¸å…³
    'rgba(150, 150, 255, 0.4)',   # äº¤é€šç‡ƒæ–™ç›¸å…³
    'rgba(200, 200, 100, 0.4)'    # å·¥ä¸šåŸæ–™ç›¸å…³
]

# åˆ›å»ºæ¡‘åŸºå›¾
fig = go.Figure(data=[go.Sankey(
    node=dict(
        pad=15,
        thickness=20,
        line=dict(color="white", width=2),
        label=labels,
        color=node_colors,
        customdata=[f'èŠ‚ç‚¹: {label}' for label in labels],
        hovertemplate='%{customdata}<br>æ€»æµé‡: %{value}<extra></extra>'
    ),
    link=dict(
        source=source,
        target=target,
        value=value,
        color=link_colors,
        customdata=[f'{labels[s]} â†’ {labels[t]}: {v}' 
                   for s, t, v in zip(source, target, value)],
        hovertemplate='%{customdata}<extra></extra>'
    )
)])

fig.update_layout(
    title={
        'text': 'èƒ½æºæµåŠ¨æ¡‘åŸºå›¾ - ä»æ¥æºåˆ°æœ€ç»ˆç”¨é€”',
        'font': {'size': 20, 'family': 'Microsoft YaHei'}
    },
    font=dict(size=12, family='Microsoft YaHei'),
    width=1200,
    height=800,
    plot_bgcolor='rgba(240, 240, 240, 0.5)'
)

# ä¿å­˜ä¸ºHTMLï¼ˆäº¤äº’å¼ï¼‰
fig.write_html('Day2_Advanced_2D/output_1_sankey_energy.html')
print("âœ“ å·²ä¿å­˜: output_1_sankey_energy.html (äº¤äº’å¼)")

# ä¿å­˜ä¸ºé™æ€å›¾ç‰‡
fig.write_image('Day2_Advanced_2D/output_1_sankey_energy.png', width=1200, height=800)
print("âœ“ å·²ä¿å­˜: output_1_sankey_energy.png (é™æ€å›¾)")

# ============================================================================
# 2. äº¤äº’å¼æ¡‘åŸºå›¾ - èµ„é‡‘æµåŠ¨
# ============================================================================
print("\n[2/2] åˆ›å»ºäº¤äº’å¼æ¡‘åŸºå›¾...")

# å®šä¹‰èŠ‚ç‚¹ - å…¬å¸èµ„é‡‘æµåŠ¨
labels_finance = [
    # èµ„é‡‘æ¥æº
    'è¥ä¸šæ”¶å…¥', 'æŠ•èµ„æ”¶ç›Š', 'å…¶ä»–æ”¶å…¥',
    # ä¸­é—´åˆ†é…
    'æ€»æ”¶å…¥', 'è¿è¥æˆæœ¬', 'å¯åˆ†é…èµ„é‡‘',
    # æœ€ç»ˆå»å‘
    'ç ”å‘æŠ•å…¥', 'å¸‚åœºè¥é”€', 'ç®¡ç†è´¹ç”¨', 'åˆ©æ¶¦åˆ†é…', 'å‚¨å¤‡é‡‘'
]

source_finance = [
    0, 1, 2,      # æ”¶å…¥æ¥æº -> æ€»æ”¶å…¥
    3, 3,         # æ€»æ”¶å…¥ -> è¿è¥æˆæœ¬ã€å¯åˆ†é…èµ„é‡‘
    5, 5, 5, 5, 5 # å¯åˆ†é…èµ„é‡‘ -> å„é¡¹æ”¯å‡º
]

target_finance = [
    3, 3, 3,      # -> æ€»æ”¶å…¥
    4, 5,         # -> è¿è¥æˆæœ¬ã€å¯åˆ†é…èµ„é‡‘
    6, 7, 8, 9, 10 # -> å„é¡¹æ”¯å‡º
]

value_finance = [
    800, 150, 50,  # æ”¶å…¥æ¥æº
    600, 400,      # æ€»æ”¶å…¥åˆ†é…
    80, 100, 120, 60, 40  # å¯åˆ†é…èµ„é‡‘ä½¿ç”¨
]

# èŠ‚ç‚¹é¢œè‰²
node_colors_finance = [
    'rgba(100, 200, 100, 0.8)',   # è¥ä¸šæ”¶å…¥ - ç»¿è‰²
    'rgba(100, 150, 200, 0.8)',   # æŠ•èµ„æ”¶ç›Š - è“è‰²
    'rgba(150, 150, 150, 0.8)',   # å…¶ä»–æ”¶å…¥ - ç°è‰²
    'rgba(255, 200, 100, 0.8)',   # æ€»æ”¶å…¥ - æ©™è‰²
    'rgba(255, 150, 150, 0.8)',   # è¿è¥æˆæœ¬ - çº¢è‰²
    'rgba(200, 200, 100, 0.8)',   # å¯åˆ†é…èµ„é‡‘ - é»„è‰²
    'rgba(150, 100, 200, 0.8)',   # ç ”å‘æŠ•å…¥ - ç´«è‰²
    'rgba(100, 200, 200, 0.8)',   # å¸‚åœºè¥é”€ - é’è‰²
    'rgba(200, 150, 100, 0.8)',   # ç®¡ç†è´¹ç”¨ - æ£•è‰²
    'rgba(100, 255, 100, 0.8)',   # åˆ©æ¶¦åˆ†é… - äº®ç»¿
    'rgba(100, 100, 255, 0.8)'    # å‚¨å¤‡é‡‘ - äº®è“
]

fig2 = go.Figure(data=[go.Sankey(
    node=dict(
        pad=20,
        thickness=25,
        line=dict(color="white", width=3),
        label=labels_finance,
        color=node_colors_finance,
        customdata=[f'{label}<br>ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…' for label in labels_finance],
        hovertemplate='<b>%{customdata}</b><br>é‡‘é¢: %{value} ä¸‡å…ƒ<extra></extra>'
    ),
    link=dict(
        source=source_finance,
        target=target_finance,
        value=value_finance,
        customdata=[f'{labels_finance[s]} â†’ {labels_finance[t]}<br>é‡‘é¢: {v} ä¸‡å…ƒ<br>å æ¯”: {v/sum(value_finance)*100:.1f}%' 
                   for s, t, v in zip(source_finance, target_finance, value_finance)],
        hovertemplate='<b>%{customdata}</b><extra></extra>'
    )
)])

fig2.update_layout(
    title={
        'text': 'å…¬å¸èµ„é‡‘æµåŠ¨æ¡‘åŸºå›¾ - äº¤äº’å¼åˆ†æ',
        'font': {'size': 20, 'family': 'Microsoft YaHei'}
    },
    font=dict(size=13, family='Microsoft YaHei'),
    width=1200,
    height=700,
    plot_bgcolor='rgba(250, 250, 250, 1)',
    annotations=[
        dict(
            text='ğŸ’¡ æç¤º: é¼ æ ‡æ‚¬åœæŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ï¼Œå¯ç¼©æ”¾å’Œæ‹–æ‹½',
            xref='paper', yref='paper',
            x=0.5, y=-0.05,
            showarrow=False,
            font=dict(size=12, color='gray')
        )
    ]
)

# ä¿å­˜äº¤äº’å¼ç‰ˆæœ¬
fig2.write_html('Day2_Advanced_2D/output_2_sankey_finance.html')
print("âœ“ å·²ä¿å­˜: output_2_sankey_finance.html (äº¤äº’å¼)")

# ä¿å­˜é™æ€å›¾ç‰‡
fig2.write_image('Day2_Advanced_2D/output_2_sankey_finance.png', width=1200, height=700)
print("âœ“ å·²ä¿å­˜: output_2_sankey_finance.png (é™æ€å›¾)")

print("\n" + "=" * 60)
print("âœ… Day 2 - ä»»åŠ¡2.2 å®Œæˆï¼")
print("å·²ç”Ÿæˆ2ä¸ªæ¡‘åŸºå›¾ç¤ºä¾‹:")
print("  1. output_1_sankey_energy.html/png - èƒ½æºæµåŠ¨")
print("  2. output_2_sankey_finance.html/png - èµ„é‡‘æµåŠ¨")
print("\nğŸ’¡ æç¤º: æ‰“å¼€HTMLæ–‡ä»¶å¯ä»¥ä½“éªŒå®Œæ•´çš„äº¤äº’åŠŸèƒ½ï¼")
print("=" * 60)
